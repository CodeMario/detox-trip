<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DetoxTrip</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 10px;
            border-bottom: 1px solid #ddd;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: white;
        }
        .logo {
            display: flex;
            align-items: center;
            color: #144e37;
            font-size: 20px;
            font-weight: bold;
        }
        .logo img {
            height: 24px;
            width: auto;
            margin-right: 5px;
        }
        .page-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .container {
            text-align: center;
        }
        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .input-group input {
            padding: 5px;
            width: 200px;
            margin-right: 5px;
            cursor: pointer;
        }
        .emoji {
            font-size: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
            width: 300px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .modal-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal select,
        .modal input {
            padding: 12px;
            font-size: 16px;
            box-sizing: border-box;
            width: 100%;
        }

        #time-modal input[type="number"] {
            width: 40%;
            display: inline-block;
            padding: 8px;
            font-size: 16px;
        }

        .modal span {
            font-size: 24px;
            margin: 0 10px;
            line-height: 40px;
            display: inline-block;
        }

        .modal input[type="number"]:nth-child(2) {
            width: 40%;
        }

        .modal button {
            margin-top: 10px;
            padding: 8px 15px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="/logo.png" alt="Logo"> DetoxTrip
        </div>
    </header>
    <div class="page-title" id="page-title"></div>
    <div class="container">
        <div class="input-group">
            <input type="text" id="location" placeholder="ì—¬í–‰ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" readonly onclick="openLocationModal()" required>
            <span class="emoji">ğŸŒ</span>
        </div>
        <div class="input-group">
            <input type="date" id="start-date" required>
            <span class="emoji">ğŸ“†</span>
        </div>
        <div class="input-group">
            <input type="date" id="end-date" required>
            <span class="emoji">ğŸ“†</span>
        </div>
        <div class="input-group">
            <input type="text" id="time" placeholder="ëª©í‘œ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”" readonly onclick="openTimeModal()" required>
            <span class="emoji">â°</span>
        </div>
        
        <button onclick="saveData()">ì €ì¥</button>
        <button onclick="cancel()">ì·¨ì†Œ</button>
    </div>

    <div id="location-modal" class="modal">
        <div class="modal-header">ì—¬í–‰ì§€ ì…ë ¥</div>
        <select id="country-select" onchange="loadRegions()">
            <option value="">êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
        <br>
        <select id="region-select">
            <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
        <br>
        <button id="confirm-location" disabled onclick="confirmLocation()">í™•ì¸</button>
        <button onclick="closeLocationModal()">ì·¨ì†Œ</button>
    </div>

    <div id="time-modal" class="modal">
        <div class="modal-header">ì‹œê°„ ì…ë ¥</div>
        <input type="number" id="hour" placeholder="HH" min="0" max="99">
        <span>:</span>
        <input type="number" id="minute" placeholder="MM" min="0" max="59">
        <br>
        <button onclick="confirmTime()">ì €ì¥</button>
        <button onclick="closeTimeModal()">ì·¨ì†Œ</button>
    </div>

    <script>
        async function checkItinerary() {
            try {
                const response = await fetch('/itineraries');
                const data = await response.json();
                const pageTitle = document.getElementById('page-title');

                console.log(data.result);

                if (data.result) {
                    pageTitle.textContent = "ì—¬í–‰ì¼ì • ìˆ˜ì •";

                    // ê¸°ì¡´ ê°’ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
                    const locationInput = document.getElementById('location');
                    const startDateInput = document.getElementById('start-date');
                    const endDateInput = document.getElementById('end-date');
                    const timeInput = document.getElementById('time');

                    // country_nameê³¼ region_nameì„ ë„ì–´ì“°ê¸°ë¡œ ì—°ê²°í•˜ì—¬ ì…ë ¥
                    const country = data.result.Destination?.country_name || "";
                    const region = data.result.Destination?.region_name || "";
                    locationInput.value = `${country} ${region}`;
                    
                    // start_dateì™€ end_date ì„¤ì •
                    startDateInput.value = data.result.start_date || "";
                    endDateInput.value = data.result.end_date || "";

                    // total_timeì„ HH:MM í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì„¤ì •
                    const totalMinutes = data.result.total_time || 0;
                    const hours = String(Math.floor(totalMinutes / 60)).padStart(2, '0');
                    const minutes = String(totalMinutes % 60).padStart(2, '0');
                    timeInput.value = `${hours}:${minutes}`;
                } else {
                    pageTitle.textContent = "ì—¬í–‰ì¼ì • ë“±ë¡";
                }
            } catch (error) {
                console.error("Error checking itinerary:", error);
                document.getElementById('page-title').textContent = "ì˜¤ë¥˜ ë°œìƒ";
            }
        }

        async function fetchDestinations() {
            try {
                const response = await fetch('/destinations');
                const data = await response.json();

                if (data.result) {
                    const countries = [...new Set(data.result.map(destination => destination.country_name))];
                    populateCountrySelect(countries);
                } else {
                    console.error("Failed to fetch destinations.");
                }
            } catch (error) {
                console.error("Error fetching destinations:", error);
            }
        }

        function populateCountrySelect(countries) {
            const countrySelect = document.getElementById('country-select');
            countrySelect.innerHTML = '<option value="">êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';

            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }

        async function loadRegions() {
            const countrySelect = document.getElementById('country-select');
            const selectedCountry = countrySelect.value;

            if (!selectedCountry) {
                document.getElementById('region-select').innerHTML = '<option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }

            try {
                const response = await fetch('/destinations');
                const data = await response.json();

                if (data.result) {
                    const regions = data.result
                        .filter(destination => destination.country_name === selectedCountry)
                        .map(destination => ({ id: destination.id, region_name: destination.region_name }));

                    populateRegionSelect(regions);
                } else {
                    console.error("Failed to load regions.");
                }
            } catch (error) {
                console.error("Error loading regions:", error);
            }
        }

        function populateRegionSelect(regions) {
            const regionSelect = document.getElementById('region-select');
            regionSelect.innerHTML = '<option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>';

            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region.region_name;
                option.textContent = region.region_name;
                option.dataset.id = region.id;
                regionSelect.appendChild(option);
            });

            document.getElementById('confirm-location').disabled = regions.length === 0;
        }

        function openLocationModal() {
            document.getElementById('location-modal').style.display = 'block';
            fetchDestinations();
        }

        function closeLocationModal() {
            document.getElementById('location-modal').style.display = 'none';
        }

        function openTimeModal() {
            document.getElementById('time-modal').style.display = 'block';
        }

        function closeTimeModal() {
            document.getElementById('time-modal').style.display = 'none';
        }

        function confirmLocation() {
            const countrySelect = document.getElementById('country-select');
            const regionSelect = document.getElementById('region-select');
            const locationInput = document.getElementById('location');

            const selectedCountry = countrySelect.value;
            const selectedRegion = regionSelect.value;
            const locationId = regionSelect.options[regionSelect.selectedIndex]?.dataset.id;

            if (selectedCountry && selectedRegion && locationId) {
                locationInput.value = `${selectedCountry} ${selectedRegion}`;
                locationInput.dataset.id = locationId;
                closeLocationModal();
            } else {
                alert("êµ­ê°€ì™€ ì§€ì—­ì„ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•´ì£¼ì„¸ìš”.");
            }
        }

        function confirmTime() {
            const hourInput = document.getElementById('hour');
            const minuteInput = document.getElementById('minute');
            const timeInput = document.getElementById('time');

            const hours = hourInput.value.padStart(2, '0');
            const minutes = minuteInput.value.padStart(2, '0');

            timeInput.value = `${hours}:${minutes}`;
            closeTimeModal();
        }

        async function saveData() {
            const locationInput = document.getElementById('location');
            const locationId = locationInput.dataset.id;
            const startDate = document.getElementById('start-date').value.trim();
            const endDate = document.getElementById('end-date').value.trim();
            const hour = parseInt(document.getElementById('hour').value, 10) || 0;
            const minute = parseInt(document.getElementById('minute').value, 10) || 0;
            const totalMinutes = hour * 60 + minute;

            // ì¼ì •ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ (í˜ì´ì§€ ì œëª©ì´ "ì—¬í–‰ì¼ì • ìˆ˜ì •"ì¸ì§€ ì²´í¬)
            const isUpdating = document.getElementById('page-title').textContent === "ì—¬í–‰ì¼ì • ìˆ˜ì •";

            const requestData = {
                destination_id: locationId || null,
                start_date: startDate || null,
                end_date: endDate || null,
                total_time: totalMinutes || null
            };

            try {
                const response = await fetch(isUpdating ? '/itineraries/update' : '/itineraries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                if (result.result == true) {
                    if (isUpdating) {
                        alert("ì—¬í–‰ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        window.location.href = "/main.html";
                    }
                    else {
                        alert("ì—¬í–‰ ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        window.location.href = "/activity.html";
                    }
                } else {
                    alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            } catch (error) {
                console.error("Error saving data:", error);
                alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function cancel() {
            window.location.href = "/main.html";
        }

        window.onload = function () {
            checkItinerary();
            fetchDestinations();
        };
    </script>
</body>
</html>